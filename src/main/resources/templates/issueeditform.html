<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!--CSS Icon-->
  <link rel="stylesheet" href="/vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="/vendors/css/vendor.bundle.base.css">
  <!--    CSS-->
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <!--JQuery-->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="shortcut icon" href="/images/favicon.png" />
  <title>Ddait 사람들을 따듯하게 잇다</title>
  <style>
    /* 메시지 알림 스타일 추가 */
    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid transparent;
      border-radius: 4px;
      text-align: center;
    }

    .alert-success {
      color: #155724;
      background-color: #d4edda;
      border-color: #c3e6cb;
    }

    .alert-error {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: #f5f5f5;
    }
    /* 고정 사이드바 */
            .sidebar {
                position: fixed;
                bottom: 0px;
                height: 100vh;
                overflow-y: auto;
            }
    /* 메인 패널 기본 설정: 사이드바 너비 만큼 왼쪽 마진 */
    .main-panel {
      transition: margin-left 0.3s ease;
    }
    .page-body-wrapper {
      margin-right: 0px;
    }
  </style>
</head>
<body>
<div class="container-scroller d-flex">
  <!-- 분리한 사이드바(fragment) 포함 -->
  <div th:replace="~{layout/sidebarinproject :: sidebar}"></div>
  <div class="container-fluid page-body-wrapper">
    <!-- 분리한 네비게이션 바(fragment) 포함 -->
    <div th:replace="~{layout/navbar :: navbar}"></div>
    <div class="main-panel">
      <div class="content-wrapper"><!--여기부터-->


        <h2>이슈 수정</h2>

        <!-- ✅ 기존 수정 & 파일 업로드를 한 번에 처리 -->
        <form th:action="@{/projects/{projectId}/board/issues/update/{id}(projectId=${projectId}, id=${issue.id})}"
              method="post" enctype="multipart/form-data">

          <!-- 제목 입력 -->
          <div class="mb-3">
            <label for="title" class="form-label">제목</label>
            <input type="text" class="form-control" id="title" name="title" th:value="${issue.title}" required>
          </div>

          <!-- 내용 입력 -->
          <div class="mb-3">
            <label for="content" class="form-label">내용</label>
            <textarea class="form-control" id="content" name="content" rows="5" th:text="${issue.content}" required></textarea>
          </div>

          <!-- ✅ 이슈 상태 선택 드롭다운 추가 -->
          <div class="mb-3">
            <label for="status" class="form-label">이슈 상태</label>
            <select class="form-select" id="status" name="status">
              <option value="IN_PROGRESS" th:selected="${issue.status == 'IN_PROGRESS'}">진행 중</option>
              <option value="COMPLETED" th:selected="${issue.status == 'COMPLETED'}">완료</option>
              <option value="ON_HOLD" th:selected="${issue.status == 'ON_HOLD'}">보류</option>
            </select>
          </div>

          <!-- ✅ 기존 파일 목록 (삭제 버튼 포함) -->
          <div class="mb-3">
            <label class="form-label">첨부된 파일</label>
            <ul class="list-group">
              <li th:each="file : ${issue.files}" class="list-group-item d-flex justify-content-between align-items-center">
                <a th:text="${file.fileName}" th:href="@{/api/files/download/{fileId}(fileId=${file.id})}" class="text-decoration-none"></a>
                <button type="button" class="btn btn-danger btn-sm delete-file-btn" th:data-file-id="${file.id}">삭제</button>
              </li>
            </ul>
          </div>

          <!-- ✅ 새 파일 업로드 -->
          <div class="mb-3">
            <label for="newFiles" class="form-label">새로운 파일 추가</label>
            <input type="file" class="form-control" id="newFiles" name="newFiles" multiple>
          </div>

          <!-- 수정 버튼 -->
          <button type="submit" class="btn btn-primary">수정</button>
        </form>

      </div><!--여기까지-->
    </div>
  </div>
</div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".delete-file-btn").forEach(button => {
      button.addEventListener("click", function () {
        const fileId = this.getAttribute("data-file-id");
        if (confirm("정말로 이 파일을 삭제하시겠습니까?")) {
          // fileId 인코딩 추가
          const encodedFileId = encodeURIComponent(fileId);

          fetch(`/api/files/delete/${encodedFileId}`, {
            method: "POST",
            headers: {
              'Content-Type': 'application/json'
            }
          })
                  .then(response => {
                    if (!response.ok) {
                      console.error(`서버 응답 오류: ${response.status}`);
                      throw new Error(`파일 삭제 실패 (HTTP ${response.status})`);
                    }
                    location.reload();
                  })
                  .catch(error => {
                    console.error("파일 삭제 오류:", error);
                    alert("파일 삭제에 실패했습니다: " + error.message);
                  });
        }
      });
    });
  });
</script>

<!--Layout 필수 자바스크립트 경로-->
<!-- base:js -->
<script src="/vendors/js/vendor.bundle.base.js"></script>
<!-- endinject -->
<!-- Plugin js for this page-->
<script src="/vendors/chart.js/Chart.min.js"></script>
<script src="/js/jquery.cookie.js" type="text/javascript"></script>
<!-- End plugin js for this page-->
<!-- inject:js -->
<script src="/js/off-canvas.js"></script>
<script src="/js/hoverable-collapse.js"></script>
<script src="/js/template.js"></script>
<!-- endinject -->
<!-- plugin js for this page -->
<script src="/js/jquery.cookie.js" type="text/javascript"></script>
<!-- End plugin js for this page -->
<!-- Custom js for this page-->
<script src="/js/dashboard.js"></script>
<!-- End custom js for this page-->

</body>
</html>



<!--&lt;!&ndash;🔹 기능 요약-->
<!--기존 이슈의 제목과 내용을 수정할 수 있는 페이지.-->

<!--🔹 구현된 기능-->
<!--✅ 기존 이슈 데이터 표시-->
<!--→ th:value="${issue.title}" (제목)-->
<!--→ th:text="${issue.content}" (내용)-->
<!--✅ 이슈 수정 요청 처리-->
<!--→ th:action="@{/projects/{projectId}/board/issues/update/{id}(projectId=${projectId}, id=${issue.id})}"-->
<!--✅ 취소 버튼 추가 (이슈 목록 페이지로 이동)-->
<!--→ th:href="@{/projects/{projectId}/board/issues(projectId=${projectId})}"-->

<!--&ndash;&gt;-->
