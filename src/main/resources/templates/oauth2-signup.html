<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Ddait 사람들을 따듯하게 잇다</title>
    <!-- base:css -->
    <link rel="stylesheet" href="../../vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="../../vendors/css/vendor.bundle.base.css">
    <!-- endinject -->
    <!-- inject:css -->
    <link rel="stylesheet" href="../../css/style.css">
    <!-- endinject -->
    <link rel="shortcut icon" href="../../images/favicon.png" />
    <style>
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }

        .input-group {
            height: auto;
            display: flex;
        }

        .form-control-lg {
            height: 50px !important;
        }

        .check-button {
            width: auto;
            background-color: #6c7293;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0; /* 왼쪽 모서리만 둥글게 제거 */
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.875rem;
            height: 50px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 0 15px !important;
            margin-left: -1px; /* 경계선 겹침 방지 */
            white-space: nowrap; /* 텍스트 줄바꿈 방지 */
        }

        .input-group input {
            flex: 1;
            margin-right: 0; /* 마진 제거 */
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .check-button:hover {
            background-color: #565977;
        }

        .address-detail {
            margin-top: 10px;
        }

        .brand-logo {
            margin-bottom: 0px !important; /* 기존 값(보통 30px)보다 줄임 */
        }

        .readonly-field {
            background-color: #f8f9fa;
            color: #666;
        }

        /* 로딩 스피너 */
        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
<div class="container-scroller d-flex">
    <div class="container-fluid page-body-wrapper full-page-wrapper d-flex">
        <div class="content-wrapper d-flex align-items-center auth px-0">
            <div class="row w-100 mx-0">
                <div class="col-lg-5 mx-auto">
                    <div class="auth-form-light text-left py-5 px-4 px-sm-5">
                        <div class="brand-logo">
                            <a href="/">
                                <img src="/images/DdaitLogo_dark.png" alt="logo">
                            </a>
                        </div>
                        <h4>추가 정보 입력</h4>
                        <h6 class="font-weight-light">서비스 이용을 위해 추가 정보를 입력해주세요.</h6>

                        <form class="pt-3" id="socialSignupForm">
                            <!-- 소셜 로그인에서 받아온 정보 -->
                            <div class="form-group">
                                <label for="email">이메일</label>
                                <input type="email" class="form-control form-control-lg readonly-field" id="email" name="email" th:value="${email}" readonly>
                            </div>

                            <div class="form-group">
                                <label for="name">이름</label>
                                <input type="text" class="form-control form-control-lg readonly-field" id="name" name="name" th:value="${name}" readonly>
                            </div>

                            <!-- 추가 입력 정보 -->
                            <div class="form-group">
                                <label for="phoneNumber">휴대폰 번호</label>
                                <input type="tel" class="form-control form-control-lg" id="phoneNumber" name="phoneNumber"
                                       placeholder="휴대폰 번호를 입력하세요" required>
                                <div id="phoneError" class="error-message"></div>
                            </div>

                            <div class="form-group">
                                <label for="address">주소</label>
                                <div class="input-group" id="address-group">
                                    <input type="text" class="form-control form-control-lg" id="address" name="address" placeholder="주소를 검색하세요" readonly required>
                                    <button type="button" onclick="findAddress()" class="check-button">주소 찾기</button>
                                </div>
                                <div class="address-detail mt-3">
                                    <label for="addressDetail">상세주소</label>
                                    <input type="text" class="form-control form-control-lg" id="addressDetail" name="addressDetail" placeholder="상세주소를 입력하세요">
                                </div>
                                <div id="addressError" class="error-message"></div>
                            </div>

                            <!-- Hidden fields -->
                            <input type="hidden" id="token" name="token" th:value="${token}">
                            <input type="hidden" id="provider" name="provider" th:value="${provider}">

                            <div class="mt-3" style="width: 100%;">
                                <button type="submit" style="width: 100%; display: block;" class="btn btn-block btn-primary btn-lg font-weight-medium auth-form-btn">가입완료</button>
                            </div>
                        </form>
                        <div id="loadingSpinner" class="loading"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- content-wrapper ends -->
    </div>
    <!-- page-body-wrapper ends -->
</div>
<!-- container-scroller -->

<!-- 다음 주소 API -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<!-- base:js -->
<script src="../../vendors/js/vendor.bundle.base.js"></script>
<!-- endinject -->
<script src="../../js/jquery.cookie.js" type="text/javascript"></script>
<!-- inject:js -->
<script src="../../js/off-canvas.js"></script>
<script src="../../js/hoverable-collapse.js"></script>
<script src="../../js/template.js"></script>
<!-- endinject -->

<script>
    // 휴대폰 번호 자동 하이픈 추가
    document.getElementById('phoneNumber').addEventListener('input', function(e) {
        let number = e.target.value.replace(/[^0-9]/g, '');
        if(number.length > 3) {
            if(number.length > 7) {
                number = number.substring(0,3) + '-' + number.substring(3,7) + '-' + number.substring(7,11);
            } else {
                number = number.substring(0,3) + '-' + number.substring(3);
            }
        }
        e.target.value = number;
    });

    // 주소 찾기
    function findAddress() {
        new daum.Postcode({
            oncomplete: function(data) {
                document.getElementById('address').value = `[${data.zonecode}] ${data.address}`;
                document.getElementById('addressDetail').focus();
            }
        }).open();
    }

    // 로그아웃 함수
    function performLogout() {
        console.log("로그아웃 처리 중...");
        // 로그인 페이지로 리다이렉트
        window.location.href = '/login';
    }

    // 폼 제출
    document.getElementById('socialSignupForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // 로딩 표시
        document.getElementById('loadingSpinner').style.display = 'block';

        // 유효성 검사
        const token = document.getElementById('token').value;
        if (!token) {
            alert('인증 토큰이 없습니다. 다시 로그인해주세요.');
            window.location.href = '/login';
            return;
        }

        // 폼 데이터 수집
        const baseAddress = document.getElementById('address').value;
        const detailAddress = document.getElementById('addressDetail').value;
        const fullAddress = detailAddress ? `${baseAddress} ${detailAddress}` : baseAddress;

        const formData = {
            token: token,
            provider: document.getElementById('provider').value,
            email: document.getElementById('email').value,
            name: document.getElementById('name').value,
            phoneNumber: document.getElementById('phoneNumber').value,
            address: fullAddress
        };

        // API 호출
        fetch('/oauth2/signup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
            .then(response => {
                console.log("Server responded with status:", response.status);
                return response.json().then(data => {
                    if (!response.ok) {
                        throw data;
                    }
                    return data;
                });
            })
            .then(data => {
                console.log("Success:", data);
                alert(data.message || '회원가입이 완료되었습니다. 다시 로그인해주세요.');

                // 로그아웃 처리 (서버에서 logout 필드가 true로 왔다면)
                if (data.logout === true) {
                    performLogout();
                } else {
                    window.location.href = '/';
                }
            })
            .catch(error => {
                console.error("Error occurred:", error);
                alert(error.message || '회원가입에 실패했습니다. 다시 시도해주세요.');
            })
            .finally(() => {
                // 로딩 숨기기
                document.getElementById('loadingSpinner').style.display = 'none';
            });
    });

    // 개발 모드에서 토큰 값 확인 (개발 완료 후 제거)
    console.log("Current token value:", document.getElementById('token').value);
</script>
</body>

</html>