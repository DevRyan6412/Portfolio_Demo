<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="../../images/favicon.png" />
    <title>Profile</title>
    <!-- base:css -->
    <link rel="stylesheet" href="../../vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="../../vendors/css/vendor.bundle.base.css">
    <!-- endinject -->
    <!-- inject:css -->
    <link rel="stylesheet" href="../../css/style.css">
    <!-- endinject -->
    <link rel="shortcut icon" href="../../images/favicon.png" />
    <style>
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }

        .input-group {
            height: auto;
            display: flex;
        }

        .form-control-lg {
            height: 50px !important;
        }

        .check-button {
            width: auto;
            background-color: #6c7293;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0; /* 왼쪽 모서리만 둥글게 제거 */
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.875rem;
            height: 50px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 0 15px !important;
            margin-left: -1px; /* 경계선 겹침 방지 */
            white-space: nowrap; /* 텍스트 줄바꿈 방지 */
        }

        .input-group input {
            flex: 1;
            margin-right: 0; /* 마진 제거 */
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .check-button:hover {
            background-color: #565977;
        }

        .address-detail {
            margin-top: 10px;
        }

        .brand-logo {
            margin-bottom: 0px !important; /* 기존 값(보통 30px)보다 줄임 */
        }
    </style>
</head>

<body>
<div class="container-scroller d-flex">
    <div class="container-fluid page-body-wrapper full-page-wrapper d-flex">
        <div class="content-wrapper d-flex align-items-center auth px-0">
            <div class="row w-100 mx-0">
                <div class="col-lg-5 mx-auto">
                    <div class="auth-form-light text-left py-5 px-4 px-sm-5">
                        <div class="brand-logo">
                            <a href="/">
                                <img src="/images/DdaitLogo_dark.png" alt="logo">
                            </a>
                        </div>
                        <h4>회원가입</h4>
                        <h6 class="font-weight-light">계정을 생성하여 서비스를 이용하세요.</h6>

                        <form class="pt-3" id="signupForm" action="/users/signup" method="post">
                            <div class="form-group">
                                <label for="name">이름</label>
                                <input type="text" class="form-control form-control-lg" id="name" name="name" placeholder="이름을 입력하세요" required>
                            </div>

                            <div class="form-group">
                                <label for="email">이메일</label>
                                <div class="input-group" id="email-group">
                                    <input type="email" class="form-control form-control-lg" id="email" name="email" placeholder="이메일 주소를 입력하세요" required>
                                    <button type="button" onclick="checkEmail()" class="check-button">중복확인</button>
                                </div>
                                <div id="emailMessage" class="error-message"></div>
                            </div>

                            <div class="form-group">
                                <label for="password">비밀번호</label>
                                <input type="password" class="form-control form-control-lg" id="password" name="password" placeholder="비밀번호를 입력하세요" required>
                            </div>

                            <div class="form-group">
                                <label for="confirmPassword">비밀번호 확인</label>
                                <input type="password" class="form-control form-control-lg" id="confirmPassword" name="confirmPassword" placeholder="비밀번호를 다시 입력하세요" required>
                                <div id="passwordMessage" class="error-message"></div>
                            </div>

                            <div class="form-group">
                                <label for="address">주소</label>
                                <div class="input-group" id="address-group">
                                    <input type="text" class="form-control form-control-lg" id="address" name="address" placeholder="주소를 검색하세요" readonly required>
                                    <button type="button" onclick="findAddress()" class="check-button">주소 찾기</button>
                                </div>
                                <div class="address-detail mt-3">
                                    <label for="addressDetail">상세주소</label>
                                    <input type="text" class="form-control form-control-lg" id="addressDetail" name="addressDetail" placeholder="상세주소를 입력하세요">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="phoneNumber">휴대폰 번호</label>
                                <input type="tel" class="form-control form-control-lg" id="phoneNumber" name="phoneNumber" placeholder="휴대폰 번호를 입력하세요" required>
                            </div>

                            <div class="mt-3" style="width: 100%;">
                                <button type="submit" style="width: 100%; display: block;" class="btn btn-block btn-primary btn-lg font-weight-medium auth-form-btn">가입하기</button>
                            </div>

                            <div class="text-center mt-4 font-weight-light">
                                이미 계정이 있으신가요? <a href="/login" class="text-primary">로그인</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- content-wrapper ends -->
    </div>
    <!-- page-body-wrapper ends -->
</div>
<!-- container-scroller -->

<!-- 다음 주소 API -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<!-- base:js -->
<script src="../../vendors/js/vendor.bundle.base.js"></script>
<!-- endinject -->
<script src="../../js/jquery.cookie.js" type="text/javascript"></script>
<!-- inject:js -->
<script src="../../js/off-canvas.js"></script>
<script src="../../js/hoverable-collapse.js"></script>
<script src="../../js/template.js"></script>
<!-- endinject -->

<script>
    let isEmailVerified = false;

    // 이메일 중복 확인
    function checkEmail() {
        const email = document.getElementById('email').value;
        const messageDiv = document.getElementById('emailMessage');

        // 이메일 유효성 검사 추가
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            messageDiv.style.color = 'red';
            messageDiv.textContent = '유효한 이메일 형식이 아닙니다.';
            return;
        }

        // 수정된 부분: params 대신 직접 URL에 쿼리 파라미터 추가
        fetch(`/api/users/check-email?email=${encodeURIComponent(email)}`, {
            method: 'GET'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.available) {
                    messageDiv.style.color = 'green';
                    messageDiv.textContent = '사용 가능한 이메일입니다.';
                    isEmailVerified = true;
                } else {
                    messageDiv.style.color = 'red';
                    messageDiv.textContent = '이미 사용중인 이메일입니다.';
                    isEmailVerified = false;
                }
            })
            .catch(error => {
                messageDiv.textContent = '확인 중 오류가 발생했습니다.';
                console.error('Error:', error);
            });
    }

    // 비밀번호 확인 체크
    document.getElementById('confirmPassword').addEventListener('input', function() {
        const password = document.getElementById('password').value;
        const confirmPassword = this.value;
        const messageDiv = document.getElementById('passwordMessage');

        if (password !== confirmPassword) {
            messageDiv.textContent = '비밀번호가 일치하지 않습니다.';
            messageDiv.style.color = 'red';
        } else {
            messageDiv.textContent = '비밀번호가 일치합니다.';
            messageDiv.style.color = 'green';
        }
    });

    document.getElementById('signupForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // 이메일 중복 확인 여부 체크
        if (!isEmailVerified) {
            alert('이메일 중복 확인을 해주세요.');
            return;
        }

        // 비밀번호 일치 여부 체크
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        if (password !== confirmPassword) {
            alert('비밀번호가 일치하지 않습니다.');
            return;
        }

        // 기본주소와 상세주소 합치기
        const baseAddress = document.getElementById('address').value;
        const detailAddress = document.getElementById('addressDetail').value;
        const fullAddress = detailAddress ? `${baseAddress} ${detailAddress}` : baseAddress;

        const formData = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            password: password,
            address: fullAddress,
            phoneNumber: document.getElementById('phoneNumber').value
        };

        fetch('/api/users/signup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                alert('회원가입이 완료되었습니다.');
                window.location.href = '/login';
            })
            .catch(error => {
                alert('회원가입에 실패했습니다.');
                console.error('Error:', error);
            });
    });

    function findAddress() {
        new daum.Postcode({
            oncomplete: function(data) {
                document.getElementById('address').value = `[${data.zonecode}] ${data.address}`;
                // 상세주소 입력 필드를 활성화
                document.getElementById('addressDetail').focus();
            }
        }).open();
    }

    // 이메일 입력 필드 변경 시 검증 상태 초기화
    document.getElementById('email').addEventListener('input', function() {
        isEmailVerified = false;
        document.getElementById('emailMessage').textContent = '';
    });
</script>
</body>

</html>