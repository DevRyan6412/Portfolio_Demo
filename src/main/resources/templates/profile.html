<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--CSS Icon-->
    <link rel="stylesheet" href="/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="/vendors/css/vendor.bundle.base.css">
    <!--    CSS-->
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!--JQuery-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="shortcut icon" href="../../images/favicon.png" />
    <title>Profile</title>
    <style>
        .container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }

        /*h2, h3 {*/
        /*    color: #333;*/
        /*    margin-bottom: 20px;*/
        /*}*/

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0,123,255,0.2);
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #0056b3;
        }

        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            padding: 10px;
            background-color: #fff;
            border-radius: 4px;
            border: 1px solid #dc3545;
        }

        .success-message {
            color: #28a745;
            font-size: 14px;
            margin-top: 5px;
            padding: 10px;
            background-color: #fff;
            border-radius: 4px;
            border: 1px solid #28a745;
        }

        .profile-info {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .profile-info p {
            margin: 15px 0;
            display: flex;
            align-items: center;
        }

        .profile-info strong {
            display: inline-block;
            width: 120px;
            color: #555;
        }

        .section {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .password-change {
            border-top: 1px solid #eee;
            margin-top: 30px;
            padding-top: 30px;
        }

        .address-section {
            display: flex;
            gap: 10px;
            align-items: start;
        }

        .address-section input {
            flex: 1;
        }

        .address-section button {
            white-space: nowrap;
        }

        .address-detail {
            margin-top: 10px;
        }

        .delete-account {
            margin-top: 40px;
            padding: 25px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .delete-account button {
            background-color: #dc3545;
        }

        .delete-account button:hover {
            background-color: #c82333;
        }

        .password-match-message {
            margin-top: 5px;
            font-size: 14px;
        }

        .password-match-message.match {
            color: #28a745;
        }

        .password-match-message.not-match {
            color: #dc3545;
        }

        .password-requirements {
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }

        /* 추가된 스타일 */
        .js-message {
            display: none;
            margin-bottom: 20px;
        }
        /* 메시지 알림 스타일 추가 */
        .alert {
          padding: 15px;
          margin-bottom: 20px;
          border: 1px solid transparent;
          border-radius: 4px;
          text-align: center;
        }

        .alert-success {
          color: #155724;
          background-color: #d4edda;
          border-color: #c3e6cb;
        }

        .alert-error {
          color: #721c24;
          background-color: #f8d7da;
          border-color: #f5c6cb;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f5f5f5;
        }
        /* 고정 사이드바 */
            .sidebar {
                position: fixed;
                bottom: 0px;
                height: 100vh;
                overflow-y: auto;
            }
        /* 메인 패널 기본 설정: 사이드바 너비 만큼 왼쪽 마진 */
        .main-panel {
          transition: margin-left 0.3s ease;
        }
        .page-body-wrapper {
            margin-right: 0px;
        }
    </style>
</head>
<body>
<div class="container-scroller d-flex">
    <!-- 분리한 사이드바(fragment) 포함 -->
    <div th:replace="~{layout/sidebarinproject :: sidebar}"></div>
    <div class="container-fluid page-body-wrapper">
        <!-- 분리한 네비게이션 바(fragment) 포함 -->
        <div th:replace="~{layout/navbar :: navbar}"></div>
        <div class="main-panel">
            <div class="content-wrapper"><!--여기부터-->
                <h2>사용자 프로필</h2>
                <input type="hidden" name="projectId" th:value="${projectId}" />
                <!-- 성공/에러 메시지 표시 -->
                <div th:if="${message}" class="success-message" th:text="${message}"></div>
                <div th:if="${error}" class="error-message" th:text="${error}"></div>

                <!-- 자바스크립트로 추가할 메시지 영역 -->
                <div id="jsMessage" class="js-message success-message"></div>
                <div id="jsErrorMessage" class="js-message error-message"></div>

                <!-- 프로필 정보 표시 -->
                <div class="profile-info">
                    <p><strong>이름:</strong> <span th:text="${user.name}">사용자 이름</span></p>
                    <p><strong>이메일:</strong> <span th:text="${user.email}">사용자 이메일</span></p>
                    <p><strong>전화번호:</strong> <span th:text="${user.phoneNumber}">전화번호</span></p>
                    <p><strong>주소:</strong> <span th:text="${user.address}">주소</span></p>
                </div>

                <!-- 프로필 수정 폼 -->
                <div class="section">
                    <h3>프로필 수정</h3>
                    <form th:action="@{/user/update}" method="post" id="profileForm">
                        <!-- 원래 값을 저장하는 hidden 필드 추가 -->
                        <input type="hidden" id="originalName" th:value="${user.name}">
                        <input type="hidden" id="originalPhoneNumber" th:value="${user.phoneNumber}">
                        <input type="hidden" id="originalAddress" th:value="${user.address}">

                        <div class="form-group">
                            <label for="name">이름</label>
                            <input type="text" id="name" name="name" th:value="${user.name}" required>
                        </div>

                        <div class="form-group">
                            <label for="phoneNumber">휴대폰 번호</label>
                            <input type="tel" id="phoneNumber" name="phoneNumber" th:value="${user.phoneNumber}"
                                   pattern="[0-9]{3}-[0-9]{4}-[0-9]{4}" title="000-0000-0000 형식으로 입력해주세요." required>
                        </div>

                        <div class="form-group">
                            <label for="address">주소</label>
                            <div class="address-section">
                                <input type="text" id="address" name="address" placeholder="우편번호를 검색하세요" readonly required>
                                <button type="button" onclick="findAddress()">주소 찾기</button>
                            </div>
                            <div class="address-detail">
                                <input type="text" id="addressDetail" name="addressDetail" placeholder="상세주소를 입력하세요">
                            </div>
                        </div>

                        <button type="submit">프로필 수정</button>
                    </form>
                </div>

                <!-- 비밀번호 변경 폼 (일반 로그인 사용자만) -->
                <div th:if="${user.provider == null}" class="section">
                    <h3>비밀번호 변경</h3>
                    <form id="passwordChangeForm" onsubmit="return handlePasswordSubmit(event)">
                        <div class="form-group">
                            <label for="currentPassword">현재 비밀번호</label>
                            <input type="password" id="currentPassword" name="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">새 비밀번호</label>
                            <input type="password" id="newPassword" name="newPassword"
                                   pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$"
                                   title="비밀번호는 8자 이상이며, 문자, 숫자, 특수문자를 포함해야 합니다."
                                   oninput="checkPasswordMatch()" required>
                            <div class="password-requirements" id="passwordRequirements"></div>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">새 비밀번호 확인</label>
                            <input type="password" id="confirmPassword" name="confirmPassword"
                                   oninput="checkPasswordMatch()" required>
                            <div class="password-match-message" id="passwordMatchMessage"></div>
                        </div>
                        <button type="submit">비밀번호 변경</button>
                    </form>
                </div>

                <!-- 회원 탈퇴 -->
                <div class="delete-account">
                    <h3>회원 탈퇴</h3>
                    <form th:action="@{/user/delete}" method="post" onsubmit="return confirmDelete()">
                        <button type="submit">회원 탈퇴</button>
                    </form>
                </div>
            </div><!--여기까지-->
        </div>
    </div>
</div>
</div>

<!-- 다음 주소 API -->
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script>
    // 주소 찾기
    function findAddress() {
        new daum.Postcode({
            oncomplete: function(data) {
                const baseAddress = `[${data.zonecode}] ${data.address}`;
                document.getElementById('address').value = baseAddress;
                document.getElementById('addressDetail').focus();
            }
        }).open();
    }

    // 회원 탈퇴 확인
    function confirmDelete() {
        return confirm('정말로 탈퇴하시겠습니까? 이 작업은 되돌릴 수 없습니다.');
    }

    // 메시지 표시 함수
    function showMessage(message, isError = false) {
        const messageElement = isError ? document.getElementById('jsErrorMessage') : document.getElementById('jsMessage');
        messageElement.textContent = message;
        messageElement.style.display = 'block';

        // 3초 후 메시지 숨기기
        setTimeout(() => {
            messageElement.style.display = 'none';
        }, 3000);
    }

    // 비밀번호 일치 여부 확인
    function checkPasswordMatch() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const matchMessage = document.getElementById('passwordMatchMessage');
        const requirements = document.getElementById('passwordRequirements');

        // 비밀번호 요구사항 검사
        const hasLetter = /[A-Za-z]/.test(newPassword);
        const hasNumber = /\d/.test(newPassword);
        const hasSpecial = /[@$!%*#?&]/.test(newPassword);
        const isLongEnough = newPassword.length >= 8;

        // 비밀번호 요구사항 메시지 업데이트
        let requirementsText = '비밀번호 요구사항: ';
        if (!isLongEnough) requirementsText += '8자 이상 필요, ';
        if (!hasLetter) requirementsText += '문자 필요, ';
        if (!hasNumber) requirementsText += '숫자 필요, ';
        if (!hasSpecial) requirementsText += '특수문자 필요, ';

        requirements.textContent = requirementsText.slice(0, -2); // 마지막 쉼표와 공백 제거

        // 비밀번호 일치 여부 메시지 업데이트
        if (newPassword === '' && confirmPassword === '') {
            matchMessage.textContent = '';
            matchMessage.className = 'password-match-message';
        } else if (newPassword === confirmPassword) {
            matchMessage.textContent = '비밀번호가 일치합니다.';
            matchMessage.className = 'password-match-message match';
        } else {
            matchMessage.textContent = '비밀번호가 일치하지 않습니다.';
            matchMessage.className = 'password-match-message not-match';
        }
    }

    // 비밀번호 변경 폼 유효성 검사
    function validatePasswordForm() {
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            alert('새 비밀번호가 일치하지 않습니다.');
            return false;
        }

        const passwordPattern = /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,}$/;
        if (!passwordPattern.test(newPassword)) {
            alert('비밀번호는 8자 이상이며, 문자, 숫자, 특수문자를 포함해야 합니다.');
            return false;
        }

        return true;
    }

    // 비밀번호 변경 폼 제출 처리
    function handlePasswordSubmit(event) {
        event.preventDefault();

        // 비밀번호 유효성 검사
        if (!validatePasswordForm()) {
            return false;
        }

        // 폼 데이터 수집
        const formData = new FormData();
        formData.append('currentPassword', document.getElementById('currentPassword').value);
        formData.append('newPassword', document.getElementById('newPassword').value);
        // confirmPassword 파라미터 추가
        formData.append('confirmPassword', document.getElementById('confirmPassword').value);

        // AJAX 요청
        fetch('/user/change-password', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (response.ok) {
                    // 성공적으로 비밀번호가 변경된 경우
                    alert('비밀번호가 성공적으로 변경되었습니다. 다시 로그인해주세요.');
                    window.location.href = '/logout'; // 로그아웃 페이지로 리다이렉트
                    return;
                } else if (response.redirected) {
                    // 서버에서 리다이렉트 응답을 보낸 경우
                    window.location.href = response.url;
                    return;
                }

                // 에러 응답 처리
                return response.json().then(errorData => {
                    throw new Error(errorData.message || '비밀번호 변경에 실패했습니다.');
                });
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message || '비밀번호 변경 중 오류가 발생했습니다.');
            });

        return false;
    }

    // 프로필 폼 제출 시 주소 합치기 및 변경사항 확인
    document.getElementById('profileForm').addEventListener('submit', function(e) {
        // 원래 값과 현재 입력값 가져오기
        const originalName = document.getElementById('originalName').value;
        const originalPhoneNumber = document.getElementById('originalPhoneNumber').value;
        const originalAddress = document.getElementById('originalAddress').value;

        const name = document.getElementById('name').value;
        const phoneNumber = document.getElementById('phoneNumber').value;
        const baseAddress = document.getElementById('address').value;
        const detailAddress = document.getElementById('addressDetail').value;

        // 주소 합치기
        let fullAddress = baseAddress;
        if (detailAddress) {
            fullAddress = `${baseAddress} ${detailAddress}`;
        }

        // 변경 여부 확인 (주소는 복잡하므로 별도 처리)
        let addressChanged = false;
        if (detailAddress) {
            // 상세 주소가 입력된 경우, 원래 주소와 다른지 확인
            addressChanged = (fullAddress !== originalAddress);
        } else {
            // 상세 주소가 없는 경우, 기본 주소만 원래 주소와 다른지 확인
            addressChanged = (baseAddress !== originalAddress);
        }

        // 변경 여부 확인
        if (name === originalName &&
            phoneNumber === originalPhoneNumber &&
            !addressChanged) {
            // 변경된 정보가 없으면 제출을 막고 메시지 표시
            e.preventDefault();
            showMessage('변경된 정보가 없습니다.', true);
            return false;
        }

        // 변경된 정보가 있으면 주소 업데이트하고 폼 제출
        if (detailAddress) {
            document.getElementById('address').value = fullAddress;
        }

        return true;
    });

    // 전화번호 자동 하이픈 추가
    document.getElementById('phoneNumber').addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^0-9]/g, '');
        if (value.length > 3 && value.length <= 7) {
            value = value.slice(0,3) + '-' + value.slice(3);
        } else if (value.length > 7) {
            value = value.slice(0,3) + '-' + value.slice(3,7) + '-' + value.slice(7,11);
        }
        e.target.value = value;
    });
</script>

<!--Layout 필수 자바스크립트 경로-->
<!-- base:js -->
<script src="/vendors/js/vendor.bundle.base.js"></script>
<!-- endinject -->
<!-- Plugin js for this page-->
<script src="/vendors/chart.js/Chart.min.js"></script>
<script src="/js/jquery.cookie.js" type="text/javascript"></script>
<!-- End plugin js for this page-->
<!-- inject:js -->
<script src="/js/off-canvas.js"></script>
<script src="/js/hoverable-collapse.js"></script>
<script src="/js/template.js"></script>
<!-- endinject -->
<!-- plugin js for this page -->
<script src="/js/jquery.cookie.js" type="text/javascript"></script>
<!-- End plugin js for this page -->
<!-- Custom js for this page-->
<script src="/js/dashboard.js"></script>
<!-- End custom js for this page-->

</body>
</html>

