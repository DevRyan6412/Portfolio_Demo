<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--CSS Icon-->
    <link rel="stylesheet" href="/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="/vendors/css/vendor.bundle.base.css">
    <!--    CSS-->
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!--JQuery-->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="shortcut icon" href="/images/favicon.png" />
    <title>Ddait ì‚¬ëŒë“¤ì„ ë”°ë“¯í•˜ê²Œ ì‡ë‹¤</title>
    <style>
        /* ë©”ì‹œì§€ ì•Œë¦¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid transparent;
            border-radius: 4px;
            text-align: center;
        }

        .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .alert-error {
            color: #721c24;
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f5f5f5;
        }
        /* ê³ ì • ì‚¬ì´ë“œë°” */
        .sidebar {
            position: fixed;
            bottom: 0px;
            height: 100vh;
            overflow-y: auto;
        }
        /* ë©”ì¸ íŒ¨ë„ ê¸°ë³¸ ì„¤ì •: ì‚¬ì´ë“œë°” ë„ˆë¹„ ë§Œí¼ ì™¼ìª½ ë§ˆì§„ */
        .main-panel {
            transition: margin-left 0.3s ease;
        }
        .page-body-wrapper {
            margin-right: 0px;
        }

        /* ë¶€ëª¨ ëŒ“ê¸€ê³¼ ìì‹ ëŒ“ê¸€ ìŠ¤íƒ€ì¼ */
        .parent-comment {
            padding: 15px;
            background-color: #fff;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }

        .child-comment {
            margin-left: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-left: 3px solid #4CAF50;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div class="container-scroller d-flex">
    <!-- ë¶„ë¦¬í•œ ì‚¬ì´ë“œë°”(fragment) í¬í•¨ -->
    <div th:replace="~{layout/sidebarinproject :: sidebar}"></div>
    <div class="container-fluid page-body-wrapper">
        <!-- ë¶„ë¦¬í•œ ë„¤ë¹„ê²Œì´ì…˜ ë°”(fragment) í¬í•¨ -->
        <div th:replace="~{layout/navbar :: navbar}"></div>
        <div class="main-panel">
            <div class="content-wrapper"><!--ì—¬ê¸°ë¶€í„°-->
                <div class="table-responsive">
                    <h1> ì´ìŠˆ ìƒì„¸ë³´ê¸°
                        <span class="float-end mb-3">
                            <a th:href="@{/projects/{projectId}/board/issues(projectId=${projectId})}" class="btn btn-inverse-primary btn-fw">ëª©ë¡ë³´ê¸°</a>
                        </span>
                    </h1>
                </div>


                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <!-- ì™¼ìª½: ì œëª© + ìƒíƒœ -->
                            <div class="col">
                                <h4 class="fw-bold d-inline" th:text="${issue.title}">ì´ìŠˆ ì œëª©</h4>
                                <!-- âœ… ìƒíƒœ ë°°ì§€ë¥¼ ì œëª© ì˜†ì— ìœ„ì¹˜ -->
                                <span th:if="${issue.status == 'IN_PROGRESS'}" class="badge bg-primary ms-2">ì§„í–‰ ì¤‘</span>
                                <span th:if="${issue.status == 'COMPLETED'}" class="badge bg-success ms-2">ì™„ë£Œ</span>
                                <span th:if="${issue.status == 'ON_HOLD'}" class="badge bg-warning ms-2">ë³´ë¥˜</span>
                            </div>
                            <!-- ì˜¤ë¥¸ìª½: ë“±ë¡ì¼ -->
                            <div class="col text-end">
                                <p class="text-muted mb-0">
                                    <strong>ë“±ë¡ì¼:</strong>
                                    <span th:text="${#temporals.format(issue.createdDate, 'yyyy-MM-dd HH:mm')}">ë“±ë¡ì¼ì‹œ</span>
                                </p>
                            </div>
                        </div>
                        <!-- ì‘ì„±ì ì •ë³´ -->
                        <div class="col">
                            <p><strong>ì‘ì„±ì:</strong> <span th:text="${issue.cName}">ì‘ì„±ìëª…</span></p>
                        </div>
                        <!-- ì´ìŠˆ ë‚´ìš© -->
                        <p th:text="${issue.content}">ì´ìŠˆ ë‚´ìš©</p>
                    </div>
                </div>

                <!--                <div class="card mb-3">-->
<!--                    <div class="card-body">-->

<!--                        &lt;!&ndash; ì‘ì„±ìì™€ ë“±ë¡ì¼ì„ í•œ í–‰ì— ë°°ì¹˜ &ndash;&gt;-->
<!--                        <div class="row align-items-center">-->
<!--                            <div class="col">-->
<!--                                <h4 class="fw-bold" th:text="${issue.title}">ì´ìŠˆ ì œëª©</h4>-->

<!--                                &lt;!&ndash; âœ… ì¶”ê°€ëœ ë¶€ë¶„: ì´ìŠˆ ìƒíƒœ í‘œì‹œ &ndash;&gt;-->
<!--                                <p>-->
<!--                                    <strong>ìƒíƒœ:</strong>-->
<!--                                    <span th:if="${issue.status == 'IN_PROGRESS'}" class="badge bg-primary">ì§„í–‰ ì¤‘</span>-->
<!--                                    <span th:if="${issue.status == 'COMPLETED'}" class="badge bg-success">ì™„ë£Œ</span>-->
<!--                                    <span th:if="${issue.status == 'ON_HOLD'}" class="badge bg-warning">ë³´ë¥˜</span>-->
<!--                                </p>-->
<!--                                -->
<!--                            </div>-->
<!--                            <div class="col text-end">-->
<!--                                <p class="text-muted mb-0">-->
<!--                                    <strong>ë“±ë¡ì¼:</strong>-->
<!--                                    <span th:text="${#temporals.format(issue.createdDate, 'yyyy-MM-dd HH:mm')}">ë“±ë¡ì¼ì‹œ</span>-->
<!--                                </p>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                        <div class="col">-->
<!--                            <p><strong>ì‘ì„±ì:</strong> <span th:text="${issue.cName}">ì‘ì„±ìëª…</span></p>-->
<!--                        </div>-->
<!--                        &lt;!&ndash; ë‚´ìš©ì€ ë³„ë„ì˜ ì˜ì—­ì— í‘œì‹œ &ndash;&gt;-->
<!--                        <p><strong></strong></p>&lt;!&ndash;ì´ìŠˆë‚´ìš© ë¶€ë¶„&ndash;&gt;-->
<!--                        <p th:text="${issue.content}">ì´ìŠˆ ë‚´ìš©</p>-->
<!--                    </div>-->
<!--                </div>-->

                <!-- ì²¨ë¶€ íŒŒì¼ -->
                <div class="card mb-3" th:if="${issue.files != null and !issue.files.empty}">
                    <div class="card-body">
                        <h5 class="card-title">ì²¨ë¶€ íŒŒì¼</h5>
                        <ul class="list-group">
                            <li th:each="file : ${issue.files}" class="list-group-item d-flex justify-content-between align-items-center">
                                <span th:text="${file.fileName}">íŒŒì¼ëª…</span>

                                <!-- âœ… ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ (ì´ë¯¸ì§€ íŒŒì¼ì¼ ê²½ìš°) -->
                                <a th:if="${file.fileType != null and file.fileType.startsWith('image/')}"
                                   th:href="@{/api/files/view/{fileId}(fileId=${file.id})}"
                                   class="btn btn-sm btn-secondary"
                                   target="_blank">
                                    ë¯¸ë¦¬ë³´ê¸°
                                </a>

                                <!-- âœ… ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
                                <a class="btn btn-sm btn-primary"
                                   th:href="@{/api/issues/{issueId}/files/download/{fileName}(issueId=${issue.id}, fileName=${file.fileName})}">
                                    ë‹¤ìš´ë¡œë“œ
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="table-responsive"><!---->
                    <div class="mb-3 float-end">
                        <a th:href="@{/projects/{projectId}/board/issues/edit/{id}(projectId=${projectId}, id=${issue.id})}"
                           class="btn btn-warning">ìˆ˜ì •</a>
                        <form th:action="@{/projects/{projectId}/board/issues/delete/{id}(projectId=${projectId}, id=${issue.id})}"
                              method="post" style="display:inline;">
                            <button type="submit" class="btn btn-danger">ì‚­ì œ</button>
                        </form>
                    </div>
                </div>


                <!-- ëŒ“ê¸€ ëª©ë¡ -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">ëŒ“ê¸€ ëª©ë¡</h5>
                        <div id="comments-container">
                            <!-- ë¶€ëª¨ ëŒ“ê¸€ë§Œ ìˆœíšŒ (parentCommentIdê°€ nullì¸ ê²½ìš°) -->
                            <div th:each="comment : ${comments}" th:if="${comment.parentCommentId == null}" class="parent-comment">
                                <div class="d-flex align-items-center justify-content-between">
                                    <!-- ì™¼ìª½: ì‘ì„±ìì™€ ë“±ë¡ì¼ -->
                                    <div>
                                        <strong th:text="${comment.cName}"></strong>
                                        <small class="text-muted" th:text="${#temporals.format(comment.createdDate, 'yyyy-MM-dd HH:mm')}"></small>
                                    </div>
                                    <!-- ì˜¤ë¥¸ìª½: ë²„íŠ¼ ê·¸ë£¹ (ë²„íŠ¼ ì‚¬ì´ ê°„ê²©ì„ ìœ„í•´ gap í´ë˜ìŠ¤ ì‚¬ìš©) -->
                                    <div class="d-flex gap-2">
                                        <!-- ëŒ€ëŒ“ê¸€ ë²„íŠ¼ -->
                                        <button class="btn btn-sm btn-outline-secondary reply-btn" th:data-comment-id="${comment.id}">ë‹µê¸€</button>

                                        <!-- ìˆ˜ì • ë²„íŠ¼: ì‘ì„±ìë§Œ ë³´ì„ -->
                                        <button th:if="${comment.createdBy == (#authentication.principal instanceof T(org.springframework.security.oauth2.core.user.OAuth2User) ? #authentication.principal.attributes['email'] : #authentication.principal.username)}"
                                                class="btn btn-sm btn-outline-warning edit-btn"
                                                th:data-comment-id="${comment.id}"
                                                th:data-content="${comment.contents}">ìˆ˜ì •</button>

                                        <!-- ì‚­ì œ ë²„íŠ¼: ì‘ì„±ìë§Œ ë³´ì„ -->
                                        <form th:if="${comment.createdBy == (#authentication.principal instanceof T(org.springframework.security.oauth2.core.user.OAuth2User) ? #authentication.principal.attributes['email'] : #authentication.principal.username)}"
                                              th:action="@{/projects/{projectId}/board/issues/{issueId}/comments/delete/{commentId}(projectId=${projectId}, issueId=${issue.id}, commentId=${comment.id})}"
                                              method="post"
                                              style="display:inline;">
                                            <button type="submit" class="btn btn-sm btn-outline-danger delete-btn">ì‚­ì œ</button>
                                        </form>
                                    </div>
                                </div>
                                <div class="my-2" th:text="${comment.contents}"></div>

                                <!-- ëŒ€ëŒ“ê¸€ ì…ë ¥ í¼ -->
                                <div class="reply-form mt-2" th:id="'reply-form-' + ${comment.id}" style="display: none;">
                                    <form th:action="@{/projects/{projectId}/board/issues/{issueId}/comments/{parentCommentId}/reply(projectId=${projectId}, issueId=${issue.id}, parentCommentId=${comment.id})}" method="post">
                                        <input type="hidden" name="userId"
                                               th:value="${#authentication.principal instanceof T(org.springframework.security.core.userdetails.UserDetails)
                                                          ? #authentication.principal.username
                                                          : #authentication.principal.getAttribute('email') ?: #authentication.name}">
                                        <input type="text" name="content" class="form-control" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”">
                                        <button type="submit" class="btn btn-sm btn-primary mt-2">ë‹µê¸€ ë“±ë¡</button>
                                    </form>
                                </div>

                                <!-- ì´ ë¶€ëª¨ ëŒ“ê¸€ì— ë‹¬ë¦° ìì‹ ëŒ“ê¸€ë“¤ (parentCommentIdê°€ í˜„ì¬ ëŒ“ê¸€ IDì™€ ì¼ì¹˜í•˜ëŠ” ê²½ìš°) -->
                                <div th:each="childComment : ${comments}" th:if="${childComment.parentCommentId != null && childComment.parentCommentId == comment.id}" class="child-comment">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <!-- ì™¼ìª½: ì‘ì„±ìì™€ ë“±ë¡ì¼ -->
                                        <div>
                                            <strong th:text="${childComment.cName}"></strong>
                                            <small th:text="${#temporals.format(childComment.createdDate, 'yyyy-MM-dd HH:mm')}"></small>
                                        </div>
                                        <!-- ì˜¤ë¥¸ìª½: ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ê·¸ë£¹ -->
                                        <div class="d-flex gap-2">
                                            <button th:if="${childComment.createdBy == (#authentication.principal instanceof T(org.springframework.security.oauth2.core.user.OAuth2User) ? #authentication.principal.attributes['email'] : #authentication.principal.username)}"
                                                    class="btn btn-sm btn-outline-warning edit-btn"
                                                    th:data-comment-id="${childComment.id}"
                                                    th:data-content="${childComment.contents}">ìˆ˜ì •</button>

                                            <form th:if="${childComment.createdBy == (#authentication.principal instanceof T(org.springframework.security.oauth2.core.user.OAuth2User) ? #authentication.principal.attributes['email'] : #authentication.principal.username)}"
                                                  th:action="@{/projects/{projectId}/board/issues/{issueId}/comments/delete/{commentId}(projectId=${projectId}, issueId=${issue.id}, commentId=${childComment.id})}"
                                                  method="post" style="display:inline;">
                                                <button type="submit" class="btn btn-sm btn-outline-danger delete-btn">ì‚­ì œ</button>
                                            </form>
                                        </div>
                                    </div>
                                    <!-- ë‚´ìš©ì€ ë²„íŠ¼ í–‰ ì•„ë˜ì— ë³„ë„ì˜ ì˜ì—­ìœ¼ë¡œ í‘œì‹œ -->
                                    <div class="my-2" th:text="${childComment.contents}"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
                <div class="card mb-3 mt-3">
                    <div class="card-body">
                        <h5 class="card-title">ëŒ“ê¸€ ì‘ì„±</h5>
                        <form id="comment-form"
                              th:action="@{/projects/{projectId}/board/issues/{issueId}/comments(projectId=${projectId}, issueId=${issue.id})}"
                              method="post">
                            <input type="hidden" name="userEmail"
                                   th:value="${#authentication.principal instanceof T(org.springframework.security.core.userdetails.UserDetails)
                              ? #authentication.principal.username
                              : #authentication.principal.getAttribute('email') ?: #authentication.name}">
                            <textarea name="content" class="form-control mb-2" rows="3" required placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                            <button type="submit" class="btn btn-primary float-end">ëŒ“ê¸€ ë“±ë¡</button>
                        </form>
                    </div>
                </div>


                <!-- ëŒ“ê¸€ ëª©ë¡ ì¹´ë“œ ë°”ë¡œ ì•„ë˜ì— í˜ì´ì§• ë²„íŠ¼ ì¶”ê°€ -->
                <nav aria-label="ëŒ“ê¸€ í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜" th:if="${totalPages > 0}">
                    <ul class="pagination justify-content-center">
                        <!-- ì´ì „ ë²„íŠ¼ - URL ìˆ˜ì • (/comments ì œê±°) -->
                        <li class="page-item" th:classappend="${(currentPage != null ? currentPage : 0) == 0} ? 'disabled'">
                            <a class="page-link"
                               th:href="@{/projects/{projectId}/board/issues/{issueId}(page=${(currentPage != null ? currentPage : 0) - 1}, projectId=${projectId}, issueId=${issue.id})}"
                               aria-label="Previous">
                                <span aria-hidden="true">ì´ì „</span>
                            </a>
                        </li>

                        <!-- í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ - URL ìˆ˜ì • (/comments ì œê±°) -->
                        <li class="page-item"
                            th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                            th:classappend="${i == (currentPage != null ? currentPage : 0)} ? 'active'">
                            <a class="page-link"
                               th:href="@{/projects/{projectId}/board/issues/{issueId}(page=${i}, projectId=${projectId}, issueId=${issue.id})}"
                               th:text="${i + 1}"></a>
                        </li>

                        <!-- ë‹¤ìŒ ë²„íŠ¼ - URL ìˆ˜ì • (/comments ì œê±°) -->
                        <li class="page-item" th:classappend="${(currentPage != null ? currentPage : 0) + 1 >= totalPages} ? 'disabled'">
                            <a class="page-link"
                               th:href="@{/projects/{projectId}/board/issues/{issueId}(page=${(currentPage != null ? currentPage : 0) + 1}, projectId=${projectId}, issueId=${issue.id})}"
                               aria-label="Next">
                                <span aria-hidden="true">ë‹¤ìŒ</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const projectId = "[[${projectId}]]";
        const issueId = "[[${issue.id}]]";

        // ğŸ”¹ ëŒ“ê¸€ ì •ë ¬ - í˜ì´ì§€ ë¡œë“œ ì‹œ ìµœì‹  ëŒ“ê¸€ì´ ì•„ë˜ì— í‘œì‹œë˜ë„ë¡ ì •ë ¬
        const commentsContainer = document.getElementById("comments-container");
        if (commentsContainer) {
            const parentComments = Array.from(commentsContainer.querySelectorAll(".parent-comment"));

            // ë¶€ëª¨ ëŒ“ê¸€ ìš”ì†Œë“¤ ì—­ìˆœìœ¼ë¡œ ì¬ì •ë ¬ (ìµœì‹ ì´ ì•„ë˜ë¡œ)
            parentComments.reverse().forEach(comment => {
                commentsContainer.appendChild(comment);
            });
        }

        // ğŸ”¹ ëŒ€ëŒ“ê¸€ ë²„íŠ¼ í´ë¦­ ì‹œ ì…ë ¥ì°½ í‘œì‹œ
        document.querySelectorAll(".reply-btn").forEach(button => {
            button.addEventListener("click", function () {
                const commentId = this.getAttribute("data-comment-id");
                const replyForm = document.getElementById(`reply-form-${commentId}`);
                if (replyForm) {
                    replyForm.style.display = (replyForm.style.display === "none" || replyForm.style.display === "") ? "block" : "none";
                }
            });
        });

        // ğŸ”¹ ëŒ“ê¸€ ìˆ˜ì • ê¸°ëŠ¥
        document.querySelectorAll(".edit-btn").forEach(button => {
            button.addEventListener("click", function () {
                const commentId = this.getAttribute("data-comment-id");
                const content = this.getAttribute("data-content");
                const newContent = prompt("ëŒ“ê¸€ ìˆ˜ì •", content);

                if (newContent && newContent !== content) {
                    fetch(`/projects/${projectId}/board/issues/${issueId}/comments/update/${commentId}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: new URLSearchParams({ newContent: newContent })
                    }).then(response => {
                        if (!response.ok) {
                            throw new Error("ëŒ“ê¸€ ìˆ˜ì • ì‹¤íŒ¨");
                        }
                        // ëª…í™•í•œ URLë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (/comments ê²½ë¡œ ì œì™¸)
                        window.location.href = `/projects/${projectId}/board/issues/${issueId}`;
                    }).catch(error => {
                        console.error("ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜:", error);
                        alert("ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    });
                }
            });
        });

        // ğŸ”¹ í¼ ì œì¶œ ì‹œ URL ì²˜ë¦¬
        document.querySelectorAll("form").forEach(form => {
            if (form.action && form.action.includes("/comments")) {
                form.addEventListener("submit", function(event) {
                    // ê¸°ì¡´ ì•¡ì…˜ì„ ìœ ì§€í•˜ë˜, ì œì¶œ í›„ ì²˜ë¦¬í•  ê²ƒì´ ìˆìœ¼ë©´ ì—¬ê¸°ì— ì¶”ê°€
                    console.log("ëŒ“ê¸€ ê´€ë ¨ í¼ ì œì¶œ:", form.action);
                });
            }
        });
    });
</script>

<!--Layout í•„ìˆ˜ ìë°”ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œ-->
<!-- base:js -->
<script src="/vendors/js/vendor.bundle.base.js"></script>
<!-- endinject -->
<!-- Plugin js for this page-->
<script src="/vendors/chart.js/Chart.min.js"></script>
<script src="/js/jquery.cookie.js" type="text/javascript"></script>
<!-- End plugin js for this page-->
<!-- inject:js -->
<script src="/js/off-canvas.js"></script>
<script src="/js/hoverable-collapse.js"></script>
<script src="/js/template.js"></script>
<!-- endinject -->
<!-- plugin js for this page -->
<script src="/js/jquery.cookie.js" type="text/javascript"></script>
<!-- End plugin js for this page -->
<!-- Custom js for this page-->
<script src="/js/dashboard.js"></script>
<!-- End custom js for this page-->

</body>
</html>